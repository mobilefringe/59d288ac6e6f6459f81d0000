<script src="//codecloud.cdn.speedyrails.net/sites/5438407c6e6f64462d020000/92b82a88144a6207ab1a5e8e0f63d3d1/craftmap.js"></script>
<div class="content_container main_container position_relative">
    <a href="#" class="locate_store">Locate store <i class="fa fa-search"></i></a>
    <div class="stores_table">
        <ul id="store_list_container_map">
            <script id="store_list_template_map" type="x-tmpl-mustache/text">
                <li><a href="#" store_id="store_{{id}}" onclick="return show_pin(this)">{{name}}</a><li>
            </script>
        </ul>
    </div>
    <div class="map_container">
        <div id="map2">
            <img alt="map" id="map_image" src="">
        </div>
    </div>
</div>

<script>
    $(document).ready(function(e){
        init(e);
        function renderAll (){
            var categories = getStoreCategories();
            var stores = getStoresList(); 
            renderStoreList('#store_list_container_map','#store_list_template_map', stores, "A", "Z");
            $.each(stores, function(i, val){
                x = val.x_coordinate - 19;
                y = val.y_coordinate - 58;
                $('#map_image').after('<div class="marker" id="store_' + val.id  + '" data-coords="' + x + ', ' + y + '" style="display:none"><a style="color:#fff" href=/stores/'+val.slug +'>' + val.name + '</a></div>')
            });  
    //         show_content();
            
    //         $("#map_image").attr("src", getPNGMapURL());
    //         $('#map2').craftmap({
    // 			image: {
    // 				width: 850,
    // 				height: 850,
    // 			},
    // 			map: {
    // 				position: 'center'
    // 			}
    // 		});
        }
        
		loadMallDataCached(renderAll); 
    });
    $(window).load(function(e){
        $("#zoom_image").attr("src", getPNGMapURL());
		$('#zoom_image').smoothZoom({
		    width: "100%",
            height: "100%",
		    initial_ZOOM: 0,
			zoom_MIN: 0,
			zoom_MAX: 200,
			responsive: true,
		    responsive_maintain_ratio: true,
			zoom_BUTTONS_SHOW : 'YES',
			pan_BUTTONS_SHOW : 'NO',
			pan_LIMIT_BOUNDARY : 'NO',
			button_SIZE: 34,
			button_ALIGN: "top right",
			zoom_OUT_TO_FIT: "YES",
			container: 'zoom_container_directory'
		});

        $('.map_pin_a').click(function(e){
            console.log("in map_pin_a");
            e.preventDefault();
            var store_x_coordinate = $(this).attr('store_x_coordinate');
    		var store_y_coordinate = $(this).attr('store_y_coordinate');
            var pin_id = $(this).attr('store_id');
            var store_name = $(this).attr('store_name');

            $('.show_pin').hide();
            $('.no_pin').show();
            $('#show_pin_store_' + pin_id).show();
            $('#no_pin_store_' + pin_id).hide();
            $('.stores_table').hide();
            add_landmark(store_x_coordinate, store_y_coordinate, pin_id, store_name);
        });
            
        show_content();
        $(window).resize();
        $("#zoom_image").click();
    });
    
    function add_landmark(store_x_coordinate, store_y_coordinate, pin_id, store_name){
        console.log("Adding landmark at",store_x_coordinate, store_y_coordinate, "for",pin_id, store_name);
		var name = store_name;
		var x_coordinate = store_x_coordinate;
		var y_coordinate = store_y_coordinate;
		var mark = "mark_store_" + pin_id;

        // Remove existing landmark
	    $('#zoom_image').smoothZoom('removeLandmark');

		// Add new landmark
		$('#zoom_image').smoothZoom('addLandmark', 
			[
			'<div class="item mark" data-show-at-zoom="0" data-position="' + x_coordinate + ',' + y_coordinate + '" id="' + mark + '">\
				<div>\
					<div class="text">\
					<strong>' + name + '</strong>\
				</div>\
				<img src="//codecloud.cdn.speedyrails.net/sites/589e308f6e6f641b9f010000/image/png/1484850466000/show_pin.png" width="40px" height="65px" alt="' + name +'" />\
				</div>\
			</div>'
			]
		);

		// Focus on new landmark
		$('#zoom_image').smoothZoom('focusTo',{
			x: x_coordinate,
			y: y_coordinate,
			zoom: 120,
			speed: 5
		});console.log("zooming to spot");
	}
</script>